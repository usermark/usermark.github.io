---
title: '[SQL] 筆記'
date: 2024-07-14 22:11:12
tags:
- SQL
- DB2
---
整理實務上常遇到的。
<!--more-->
# 查詢資料

## 取前幾筆

_DB2_

```sql
SELECT * FROM zoo FETCH FIRST 1 ROWS ONLY
```

## 取後幾筆

_DB2_

```sql
SELECT * FROM zoo ORDER BY critter DESC FETCH FIRST 1 ROWS ONLY
```

## 分頁查詢

_DB2_

```sql
SELECT * FROM (SELECT rownumber() OVER (ORDER BY critter) as ROWID, a.* FROM zoo a) WHERE ROWID BETWEEN 11 AND 20
```

## 串接 Group 後的欄位

_DB2_

```sql
SELECT category, LISTAGG(id, ', ') as ids FROM myTable GROUP BY category;
```

## 取得當前的日期

_DB2_

```sql
SELECT VARCHAR_FORMAT(CURRENT_DATE, 'YYYYMMDD') FROM SYSIBM.SYSDUMMY1;
SELECT VARCHAR_FORMAT(CURRENT_DATE, 'YYYYMMDD') FROM mytable;
--或是
SELECT date(current timestamp) FROM SYSIBM.SYSDUMMY1;
SELECT date(current timestamp) FROM mytable;
```

## 取得當前的日期和時間

_DB2_

```sql
SELECT VARCHAR_FORMAT(CURRENT TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS') FROM SYSIBM.SYSDUMMY1;
```

## 查詢欄位值為純數字

_DB2_

```sql
SELECT * FROM mytable WHERE REGEXP_LIKE(mycolumn, '^[0-9]+$')
```

## 找出在 table1 中但不在 table2 中的記錄

使用 EXCEPT 運算子

```sql
SELECT * FROM table1
EXCEPT
SELECT * FROM table2;
```

使用 NOT EXISTS

```sql
SELECT *
FROM table1 t1
WHERE NOT EXISTS (
    SELECT 1 
    FROM table2 t2 
    WHERE t1.key_column = t2.key_column
);
```

## 找出重複的截取值

例如找出前8碼重複資料

```sql
SELECT *
FROM users
WHERE substr(idn, 1, 8) IN (
    SELECT substr(idn, 1, 8)
    FROM users
    GROUP BY substr(idn, 1, 8)
    HAVING COUNT(*) > 1
)
ORDER BY idn;
```

如果該欄位有index，可改用 EXISTS 和 LIKE 找出重複的記錄

```sql
SELECT *
FROM users u1
WHERE EXISTS (
    SELECT 1
    FROM users u2
    WHERE u2.idn LIKE CONCAT(substr(u1.idn, 1, 8), '%')
      AND u2.idn != u1.idn  -- 排除自己
)
ORDER BY idn
```

# 修改資料

## 插入不存在的記錄

```sql
INSERT INTO target_table (id, name, status, created_date)
SELECT ?, ?, ?, CURRENT_TIMESTAMP
FROM SYSIBM.SYSDUMMY1
WHERE NOT EXISTS (
    SELECT 1 FROM target_table WHERE id = ?
);
```

# 修改結構

## 新增欄位

_DB2_

```sql
ALTER TABLE mytable
  ADD COLUMN mycolumn1 VARCHAR (45) DEFAULT
  ADD COLUMN mycolumn2 VARCHAR (20) DEFAULT;
```

## 調整欄位大小

_DB2_

```sql
ALTER TABLE mytable 
  ALTER COLUMN mycolumn1 SET DATA TYPE VARCHAR (200)
  ALTER COLUMN mycolumn2 SET DATA TYPE VARCHAR (200);
```

## 重新命名欄位

_DB2_

```sql
ALTER TABLE mytable
  RENAME COLUMN mycolumn1 TO mycolumn11;
```

## 搬移指定資料到新的資料表

_MSSQL_

```sql
-- 1. 建立新 table 並複製資料
SELECT * 
INTO new_table_name
FROM original_table_name
WHERE your_condition;

-- 2. 從原 table 刪除已搬移的資料
DELETE FROM original_table_name 
WHERE your_condition;
```

# 預存程序

_DB2_
傳回單一結果集，參考https://www.ibm.com/docs/zh-tw/db2/11.5?topic=procedures-returning-result-sets-from-sql

```sql
CREATE OR REPLACE PROCEDURE sp_read_emp(IN p_job VARCHAR(10))
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN
  DECLARE c_emp CURSOR WITH RETURN FOR
    SELECT salary, bonus, comm
    FROM employee
    WHERE job != p_job;

  OPEN c_emp;
END;

CALL sp_read_emp('PRES');
```
